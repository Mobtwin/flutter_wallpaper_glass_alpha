name: Build Flutter App

on:
  repository_dispatch:
    types: [dispatch-android]
  workflow_dispatch:  # Allows manual triggering

jobs:


  

  build-ios:
    name: Build iOS
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: stable
        flutter-version: '3.24.2'

    - name: Install dependencies
      run: flutter pub get
    - name: Set up Provisioning Profile
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "${{ secrets.PROVISIONING_PROFILE }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/TESTID.mobileprovision

    - name: Update ExportOptions.plist
      run: |
        cat > ExportOptions.plist <<EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>com.example.wallpapers</key>
                <string>TESTID</string>
            </dict>
            <key>signingStyle</key>
            <string>manual</string>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>teamID</key>
            <string>${{ secrets.DEVELOPMENT_TEAM }}</string>
          </dict>
          </plist>
          EOF
    
    # 5. Set up Xcode for Archive
    - name: Set up Xcode
      run: |
        cd ios
        xcodebuild archive \
          -workspace Runner.xcworkspace \
          -scheme Runner \
          -archivePath ./build/Runner.xcarchive \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM=${{ secrets.DEVELOPMENT_TEAM }} \
          PROVISIONING_PROFILE_SPECIFIER=${{ secrets.PROVISIONING_PROFILE }}
      env:
        FLUTTER_ROOT: ${{ runner.tool_cache }}/flutter

    # 6. Export the .ipa
    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath ./ios/build/Runner.xcarchive \
          -exportPath ./ios/build/ipa \
          -exportOptionsPlist ./ios/exportOptions.plist
      env:
        FLUTTER_ROOT: ${{ runner.tool_cache }}/flutter

    # 7. Upload .ipa as an artifact
    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v3
      with:
        name: ios-ipa
        path: ios/build/ipa/Runner.ipa
    
  transfer_to_server:
    needs: build-ios
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: ios-ipa
          path: ios-ipa
      - name: Transfer ipa to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "ios-ipa"
          target: "/root/ios"
